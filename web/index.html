<!doctype html>
<html lang="pt-BR">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>MovieFlix â€¢ Demo</title>
  <style>
    body { font-family: system-ui, Arial; max-width: 900px; margin: 24px auto; padding: 0 12px; }
    h1 { margin-bottom: 6px; }
    section { margin: 16px 0; padding: 12px; border: 1px solid #ddd; border-radius: 8px; }
    label { display: block; margin: 6px 0 4px; font-weight: 600; }
    input, select { padding: 8px; width: 100%; box-sizing: border-box; }
    button { padding: 8px 12px; margin-top: 8px; cursor: pointer; }
    table { width: 100%; border-collapse: collapse; margin-top: 8px; }
    th, td { border: 1px solid #eee; padding: 8px; text-align: left; }
    small.mono { font-family: ui-monospace, Menlo, Consolas, monospace; color: #555; }
  </style>
</head>
<body>
  <h1>ðŸŽ¬ MovieFlix <small class="mono">frontend simples</small></h1>
  <p>Cadastre filmes, avalie e visualize â€” API via <code>/api</code>.</p>

  <section>
    <h3>Novo filme</h3>
    <label for="title">TÃ­tulo</label><input id="title" />
    <label for="year">Ano</label><input id="year" type="number" />
    <label for="genre">GÃªnero</label><input id="genre" />
    <button onclick="addMovie()">Adicionar</button>
    <div id="msg1" role="status" aria-live="polite"></div>
  </section>

  <section>
    <h3>Filmes</h3>
    <button onclick="loadMovies()">Atualizar lista</button>
    <table>
      <thead><tr><th>ID</th><th>TÃ­tulo</th><th>Ano</th><th>GÃªnero</th><th>AÃ§Ãµes</th></tr></thead>
      <tbody id="movies"></tbody>
    </table>
  </section>

  <section>
    <h3>Nova avaliaÃ§Ã£o</h3>
    <label for="movie_id">ID do filme</label><input id="movie_id" type="number" />
    <label for="rating">Nota (0 a 10)</label><input id="rating" type="number" step="0.1" />
    <button onclick="addRating()">Avaliar</button>
    <div id="msg2" role="status" aria-live="polite"></div>
  </section>

  <section>
    <h3>AvaliaÃ§Ãµes do filme</h3>
    <label for="movie_id_q">ID do filme</label><input id="movie_id_q" type="number" />
    <button onclick="loadRatings()">Ver avaliaÃ§Ãµes</button>
    <table>
      <thead><tr><th>ID</th><th>Filme</th><th>Nota</th><th>Quando</th></tr></thead>
      <tbody id="ratings"></tbody>
    </table>
  </section>

  <section>
    <h3>Insights (Data Mart)</h3>
    <button onclick="loadInsights()">Carregar insights</button>

    <h4>Top 10 por gÃªnero</h4>
    <table>
      <thead><tr><th>GÃªnero</th><th>TÃ­tulo</th><th>MÃ©dia</th><th>#AvaliaÃ§Ãµes</th></tr></thead>
      <tbody id="top10"></tbody>
    </table>

    <h4>MÃ©dia por faixa etÃ¡ria</h4>
    <table>
      <thead><tr><th>Faixa</th><th>MÃ©dia</th><th>#AvaliaÃ§Ãµes</th></tr></thead>
      <tbody id="avgAge"></tbody>
    </table>

    <h4>AvaliaÃ§Ãµes por paÃ­s</h4>
    <table>
      <thead><tr><th>PaÃ­s</th><th>#AvaliaÃ§Ãµes</th></tr></thead>
      <tbody id="byCountry"></tbody>
    </table>
  </section>

  <script>
    // Helper para o backend Node (CRUD filmes/ratings)
    const api = (path, opts = {}) =>
      fetch('/api' + path, { headers: { 'Content-Type': 'application/json' }, ...opts });

    // Base para os endpoints de insights (FastAPI)
    const INSIGHTS_BASE = 'http://localhost:8000';

    // ---- Filmes / AvaliaÃ§Ãµes ----
    async function loadMovies() {
      const res = await api('/movies');
      const data = await res.json();
      const tbody = document.getElementById('movies');
      tbody.innerHTML = '';
      data.forEach(m => {
        const tr = document.createElement('tr');
        tr.innerHTML = `
          <td>${m.id}</td>
          <td>${m.title}</td>
          <td>${m.year ?? ''}</td>
          <td>${m.genre ?? ''}</td>
          <td><button onclick="delMovie(${m.id})">Excluir</button></td>`;
        tbody.appendChild(tr);
      });
    }

    async function addMovie() {
      const title = document.getElementById('title').value;
      const year  = parseInt(document.getElementById('year').value || '');
      const genre = document.getElementById('genre').value;
      const res = await api('/movies', { method: 'POST', body: JSON.stringify({ title, year, genre }) });
      document.getElementById('msg1').textContent = res.ok ? 'Filme cadastrado!' : 'Erro ao cadastrar';
      loadMovies();
    }

    async function delMovie(id) {
      await api('/movies/' + id, { method: 'DELETE' });
      loadMovies();
    }

    async function addRating() {
      const movie_id = parseInt(document.getElementById('movie_id').value);
      const rating   = parseFloat(document.getElementById('rating').value);
      const res = await api('/ratings', { method: 'POST', body: JSON.stringify({ movie_id, rating }) });
      document.getElementById('msg2').textContent = res.ok ? 'AvaliaÃ§Ã£o registrada!' : 'Erro ao avaliar';
    }

    async function loadRatings() {
      const id = document.getElementById('movie_id_q').value;
      const res = await api('/ratings?movieId=' + id);
      const data = await res.json();
      const tbody = document.getElementById('ratings');
      tbody.innerHTML = '';
      data.forEach(r => {
        const tr = document.createElement('tr');
        tr.innerHTML = `
          <td>${r.id}</td>
          <td>${r.movie_id}</td>
          <td>${r.rating}</td>
          <td>${r.created_at}</td>`;
        tbody.appendChild(tr);
      });
    }

    // ---- Insights do Data Mart ----
    async function loadInsights() {
      try {
        const [a, b, c] = await Promise.all([
          fetch(`${INSIGHTS_BASE}/api/insights/top10-by-genre`).then(r => {
            if (!r.ok) throw new Error('top10-by-genre ' + r.status);
            return r.json();
          }),
          fetch(`${INSIGHTS_BASE}/api/insights/avg-by-age`).then(r => {
            if (!r.ok) throw new Error('avg-by-age ' + r.status);
            return r.json();
          }),
          fetch(`${INSIGHTS_BASE}/api/insights/by-country`).then(r => {
            if (!r.ok) throw new Error('by-country ' + r.status);
            return r.json();
          })
        ]);

        document.getElementById('top10').innerHTML =
          a.map(x => `<tr><td>${x.genre ?? ''}</td><td>${x.title}</td><td>${(+x.avg_rating).toFixed(2)}</td><td>${x.n_ratings}</td></tr>`).join('');

        document.getElementById('avgAge').innerHTML =
          b.map(x => `<tr><td>${x.age_range}</td><td>${(+x.avg_rating).toFixed(2)}</td><td>${x.n}</td></tr>`).join('');

        document.getElementById('byCountry').innerHTML =
          c.map(x => `<tr><td>${x.country}</td><td>${x.n}</td></tr>`).join('');
      } catch (e) {
        alert('Falha ao carregar insights: ' + e.message);
      }
    }

    // Carrega lista de filmes ao abrir
    loadMovies();
  </script>
</body>
</html>
